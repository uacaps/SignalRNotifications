function NotificationViewModel(e,t){var n=this;ko.mapping.fromJS(e,{observe:["read"]},n);n.parent=t;n.shortText=ko.computed(function(){var e=n.text;var t=150;if(e.length>t)e=e.substr(0,t-3)+"...";return e});n.go=function(){if(!n.read())n.parent.markAsRead(n);window.location=n.url};n.ageDateString=function(e){var t=(new Date).getTime();var n=0;if(typeof e==="Date")n=e.getTime();else n=(new Date(e)).getTime();var r=t-n;var i=r/1e3;if(i<60){return Math.round(i)+" seconds ago"}else{var s=i/60;if(s<60){return Math.round(s)+" minutes ago"}else{var o=s/60;if(o<24){return Math.round(o)+" hours ago"}else{var u=o/24;return Math.round(u)+" days ago"}}}}(n.dateTime)}function NotificationsViewModel(e){var t=this;e=e||{};t.url=e.url||"/api/notifications/";t.username=e.username||"";t.readType=e.readType||"view";if($.connection&&$.connection.notificationMessageHub){t.signalRClient=$.connection.notificationMessageHub.client;t.signalRServer=$.connection.notificationMessageHub.server}t.loading=ko.observable(false);t.notifications=new ko.observableArray([]);t.unreadNotifications=ko.computed(function(){return t.notifications().where(function(e){return!e.read()})});t.hasMoreNotifications=ko.observable(true);t.loadMoreNotifications=function(){t.loading(true);var e=10;var n=t.notifications().length;var r=t.url+"?username="+t.username+"&offset="+n+"&max="+e;$.ajax({type:"GET",url:r,cache:false,success:t.loadMoreNotificationsCallback,dataType:"json"})};t.loadMoreNotificationsCallback=function(e){if(e.length>0){var n=e.select(function(e){return new NotificationViewModel(e,t)});if(t.notifications().length==0){t.notifications(n)}else{n.forEach(function(e){t.notifications.push(e);if(t.readType=="view"&&!e.read())t.markAsRead(e)})}}else{t.hasMoreNotifications(false)}t.loading(false)};t.markAsRead=function(e){$.post(t.url+e.id+"/read",{});e.read(true)};t.markAsReadById=function(e){var n=t.notifications().first(function(t){return t.id==e});if(n!=null)t.markAsRead(n)};t.markAllAsRead=function(){t.notifications().where(function(e){return!e.read()}).forEach(function(e){t.markAsRead(e)})};t.addNotification=function(e,n,r,i,s,o){o=o||1e3*5;t.notifications.unshift(new NotificationViewModel({id:e,title:n,text:r,image:i,url:s,read:false,dateTime:(new Date).toString("MM/dd/yyyy hh:mm tt")}),t);if($.gritter)$.gritter.add({title:'<a href="'+s+'">'+n+"</a>",text:r,image:i,sticky:false,time:o})};if(t.signalRClient){t.signalRClient.addNotification=t.addNotification;t.signalRClient.markNotificationAsRead=t.markAsReadById}t.init=function(){t.loadMoreNotifications();if(t.signalRServer)t.signalRServer.joinGroup("User-"+t.username)}}ko.bindingHandlers.dropdownShow={init:function(e,t,n,r,i){var s=t();var o=ko.unwrap(s);$(e).on("shown.bs.dropdown",o)},update:function(e,t,n,r,i){}}